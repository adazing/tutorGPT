<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.5/purify.min.js"></script>
  <title>TutorGPT</title>
</head>
<body>
  <div class="logo"></div>
  <div class="flex-col cont-isr mcnt">
    <div class="content isr mcs glow">
      <div class="flex-col">
        <div class="timer"></div>
        <span class="prob">Problem</span>
        <div class="options">
          <div class="opt opt-1" value="1"><span class="ic">1</span>Choice 1</div>
          <div class="opt opt-2" value="2"><span class="ic">2</span>Choice 2</div>
          <div class="opt opt-3" value="3"><span class="ic">3</span>Choice 3</div>
          <div class="opt opt-4" value="4"><span class="ic">4</span>Choice 4</div>
        </div>
      </div>
    </div>
  </div>
  <div class="flex-col cont-ntr mcnt">
    <div class="ntr mcs glow">
      <div class="flex-col">
        <span class="pn">Paste your notes here:</span>
        <div class="ahhhhhhhhhhh-whuhakshdfuiahsuifhuiasdefhiklsdhfjklsdhfkljsdahfjklsdhfjklsdhafjkladhjklfashjklfhjkfhasfhlfklahfkhjsdfasdd-i-like-chicken-nuggets-asjkdhfklasdhiflhasuiohfilsahdfjklsdhklfhasdklfhaweuiohrcioasmyfuioaymiogudiolilughuifgiuadfhgiasdfhguildfhsuilghaiduhgilasuhilfguasdhuilfasdhuilfshuilfasdhuilfhasdilufhsuilafhsuiladhf-huh-asildhflasdifuhsdauiklfhaskfhlksdahkflasdhuifhskladfhilas-i-like-planes-kasjdhfklashildfhuklasdfhklsdhfjklasdfhklashfjkhasklfhaskfhasjkfhsjkdfhjklasdfhjkasdfhklasdhfkljasd-i-like-trains-asikldhjfasdylfkdhasilfhsduklahfklashfdklashjkfashkldfhasdjklfhuklasdhfjkasdhklfhjkladshjklasdhfklsdahfjklas-yay-ajksdhfklasdhklfasdhjkflhasdkfhkjlszhdklfjashjkl">
          <textarea class="pn-inp"></textarea>
          <span class="char-limit"></span>
          <input class="time-inp" placeholder="Time (seconds)" type="number" />
        </div>
        <button class="go">Let's GO!</button>
      </div>
    </div>
  </div>
  <div class="flex-col cont-gg mcnt">
    <div class="mcs gg">
      <div class="flex-col">
        <span class="pn ww">You Won! </span>
        <button class="reset">Back to Start</button>
      </div>
    </div>
  </div>
  <script>
    const genRandomToken = () => {
      const TOKEN_BASE_LEN = 5;

      let token = "";
      const validChars = "134567890QWERTYUIOPADFGHJKLZXCVBNM";
      for (let i=0;i<TOKEN_BASE_LEN;i++) {
        token += validChars.charAt(Math.random() * validChars.length);
      }
      return token + Date.now().toString().substring(7, 10);
    };

    const mkdwnToHTML = (mkdwn) => {
      return DOMPurify.sanitize(marked.parse(mkdwn));
    };

    const loadQuestion = (cnt, question) => {
      $(".prob").html(`Problem ${cnt+1}/20: ${mkdwnToHTML(question.text)}`);
      for(let i=0;i<4;i++) {
        $(`.opt-${i+1}`).html(mkdwnToHTML(question.choices[i]));
      }
    };

    const TRANS_BRK_MS = 1000;

    const updTrans = (elementQuery, trans) => {
      $(elementQuery).removeClass("op-open").removeClass("op-close").removeClass("ms-open").removeClass("ms-close").addClass(trans);
    }

    const endRun = (audio, wasWin) => {
      audio.pause();
      const url = new URL(window.location);
      url.searchParams.delete("token");
      updTrans(".cont-isr", "op-close");
      $(".cont-ntr").css("opacity", "0");
      $(".ww").html(wasWin ? "You Won! ðŸŽ‰" : "Try Again... You Got This! ðŸ˜¤")
      setTimeout(() => {
        updTrans(".cont-gg", "op-open");
        $(".reset").on("click", () => {
          runNone();
        });
      }, TRANS_BRK_MS);
    };

    const runRun = (url, token, notes, time) => {
      history.pushState({ running: true, notes: notes, time: time }, '', url);

      post("/api/get_questions", {
        token: token,
        notes: notes,
      }).then((questions) => {
        $(() => {
          updTrans(".cont-ntr", "ms-close");
          $(".cont-gg").css("opacity", "0");
          setTimeout(() => {
            updTrans(".cont-isr", "ms-open");
      
            let solved = false;
            
            const totalTimeMS = time * 1000;
            let initialTimeMS = Date.now();
            let penaltyTimeMS = 0;
            const penaltyIncrementMS = 1000;
      
            const audio = new Audio("ticking.mp3");
            audio.play();
      
            const intervalUpdateMS = 10;
            const interval = setInterval(() => {
              timeLeftMS = initialTimeMS + totalTimeMS - penaltyTimeMS - Date.now();
              $(".timer").css("--_mp", `${Math.max(timeLeftMS * 200 / totalTimeMS, 0)}% 100%`);
              if (timeLeftMS <= 0) {
                clearInterval(interval);
                if (!solved) {
                  endRun(audio, false);
                }
              }
            }, intervalUpdateMS);
    
            $("body").on("keypress", (e) => {
              if (e.which >= 49 && e.which <= 52) {
                $(`.opt-${e.which-48}`).trigger("click");
              }
            });
    
            let q=0;
            $(".opt").on("click", (e) => {
              const choice = parseInt($(e.target).attr("value"));
              post("/api/check", {q: questions[q].id, a: choice, token: token}).then((correct) => {
                if (correct) {
                  console.log("correct");
                  (new Audio("correct.mp3")).play();
                  if (++q===questions.length) {
                    solved = true;
                    endRun(audio, true);
                  } else {
                    loadQuestion(q);
                  }
                } else {
                  console.log("incorrect");
                  (new Audio("incorrect.mp3")).play();
                  loadQuestion(q+1);
                  penaltyTimeMS += penaltyIncrementMS;
                }
              })
            });
          }, TRANS_BRK_MS);
        });
      });
    };

    const CHAR_LIMIT = 15000;
    const updCharLimit = () => {
      const len = $(".pn-inp").val().length;
      $(".char-limit").html(`${len}/${CHAR_LIMIT}`).css("color", len <= CHAR_LIMIT ? "inherit" : "var(--c_err)");
    };

    const post = async (url, data) => {
      return await fetch(url, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json", 
        },
        body: JSON.stringify(data),
      });
    };

    const runNone = () => {
      // TODO: uncomment below line
      //history.pushState({ running: false }, "", "/");

      $(".cont-isr").css("opacity", "0");
      updTrans(".cont-gg", "op-close");
      setTimeout(() => {
        updTrans(".cont-ntr", "op-open");
  
        let clicked = false;
        $(".go").on("click", () => {
          const len = $(".pn-inp").val().length;
          const psi = parseInt($(".time-inp").val());
          if (!clicked && len && len <= CHAR_LIMIT && $(".time-inp").val().length > 0 && (psi || psi===0)) {
            clicked = true;
            const url = new URL(window.location);
            const token = genRandomToken();
            url.searchParams.set("token", token);
            runRun(url, token, $(".pn-inp").val(), psi);
          }
        });
        $(".pn-inp, .time-inp").on("input", () => {
          updCharLimit();
          const len = $(".pn-inp").val().length;
          const psi = parseInt($(".time-inp").val());
          if (!clicked && len && len <= CHAR_LIMIT && $(".time-inp").val().length > 0 && (psi || psi===0)) $(".go").addClass("avail");
          else $(".go").removeClass("avail");
        });
        $(".time-inp").on("keypress", (e) => {
          if ((e.which < 49 || e.which > 59) && (e.which !== 46)) {
            e.preventDefault();
          }
        })
      }, TRANS_BRK_MS);
    };

    $(() => {
      $(window).on("popstate", (e) => {
        console.log(e.state);
        const url = new URL(window.location);
        const token = url.searchParams.get("token");
        if (e.state.running && e.state.notes && e.state.time && token) {
          runRun(url, token, e.state.notes, e.state.time);
        } else {
          runNone();
        }
      });
      updCharLimit();
      runNone();
    });
  </script>
</body>
</html>